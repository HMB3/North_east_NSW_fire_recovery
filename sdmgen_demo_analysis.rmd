---
title: "sdmgen : a pacakge for rapidly estimating multiple species ranges and habit sutiability"
authors: "Hugh Burley, John Baumgartner, Linda Beaumont"
date: "March 2020"
output:
  html_document:
  toc: true             # Table of content true
toc_depth: 4            # Up to three depths of headings (specified by #, ## and html_document
toc_float: true
number_sections: false  # If you want number sections at each table header
theme: united           # Many options for theme, this one is my favorite.
highlight: tango        # Specifies the syntax highlighting style
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
css: styles.css
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---


<style>
p.caption {
font-size: 6;
}
</style>



\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the effect
of climate change on a species within Australia, from downloading occurrence records, through to creating
maps of predicted climatic suitability across Australia at 1km*1km resolution. An example of this work is 
published in Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 


\


### To install, run :

```{r message=FALSE, echo=FALSE, warning=FALSE}

## The package should import all the required packges
#devtools::install_github("HMB3/sdmgen")
library(sdmgen)


## Load the packages
data("sdmgen_packages")
sapply(sdmgen_packages, require, character.only = TRUE)


```


\


# STEP 1 :: Download species occurrence data


\

The backbone of the R workflow is a list of (taxonomically Ridgey Didge!) species names 
that we supply. The analysis is designed to process data for one species at a time, 
allowing species results to be updated as required. We can demonstrate the workflow 
using a sample of 10 plant species from the Stoten publication above. 


\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Use the first 10 plant species in the Stoten list
data("plant.spp")
analysis_spp <- plant.spp[1:10]
analysis_spp

```

\

This species list is then supplied to a series of functions to calculate enviromnetal ranges and habitat 
suitability. The initial functions download all species records from the Atlas and living Australia
(https://www.ala.org.au/) and the Global Biodiversity Information Facility (GBIF, https://www.gbif.org/). 
It downloads the species data as individual .Rdata files to the specified folders, which must exist first, 
without returning anything. The functions are separated because the ALA and GBIF columns are slightly 
different, but both data sources are needed to properly quantify species ranges .

\

The package functions expect these folders, create them if they don't exist

```{r message=FALSE, echo=FALSE, warning=FALSE}

## The functions expect these folders, create them if they don't exist
ALA_dir  <- './data/ALA'
GBIF_dir <- './data/GBIF'


## Create ALA subfolder
if(!dir.exists(ALA_dir)) {
  message('Creating MESS directory for ', species)
  dir.create(ALA_dir) } else {
    'ALA directory already exists'}


## Create GBIF subfolder
if(!dir.exists(GBIF_dir)) {
  message('Creating MESS directory for ', species)
  dir.create(GBIF_dir) } else {
    'GBIF directory already exists'}

```

\

Download GBIF and ALA occurrence data for each species

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Download GBIF occurrence data for each species
download_GBIF_all_species(species_list  = analysis_spp,
                          download_path = "./data/GBIF/",
                          download_limit = 20000)


## Download ALA occurrence data for each species
download_ALA_all_species(species_list  = analysis_spp,
                         your_email    = 'hugh.burley@gmail.com',
                         download_path = "./data/ALA/",
                         download_limit = 20000)

``` 

\

# STEP 2 :: Combine species occurrence data

\

The next function combines ALA and GBIF records, filtering them to records on land, 
and recorded after 1950. The climate (i.e. raster) data  used can be any worldclim layer.

\

First, get some global climate data from worldclim. You need to create a 'data' folder 
in the project directory.

\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Download global raster for minimum temperature 
worldclim_climate     <- raster::getData('worldclim', var = 'bio', res = 2.5, path = './data')
worldclim_annual_temp <- raster::stack("./data/wc2-5/bio1.bil")
sp::plot(worldclim_climate[["bio1"]])

``` 

\

Then trim the occurrence records to those inside the raster boundaries (i.e. species records in the ocean
according to the Raster boundaries will be excluded)

\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Combine ALA data, and filter to records on land taken > 1950
## The climate data is the worldclim version 1.0
ALA.LAND = combine_ala_records(species_list      = analysis_spp,
                               records_path      = "./data/ALA/",
                               records_extension = "_ALA_records.RData",
                               record_type       = "ALA",
                               keep_cols         = ALA_keep,
                               world_raster      = worldclim_annual_temp)


## Combine GBIF data and filter to records on land taken > 1950
GBIF.LAND = combine_gbif_records(species_list      = analysis_spp,
                                 records_path      = "./data/GBIF/",
                                 records_extension = "_GBIF_records.RData",
                                 record_type       = "GBIF",
                                 keep_cols         = gbif_keep,
                                 world_raster      = worldclim_annual_temp)

``` 

\

# STEP 3 :: extract environmental values

\

The next function in the workflow combines occurrence files from ALA and GBIF into one table, 
and extracts environmental values. It assumes that both files come from the combine_ala_records 
and combine_gbif_records functions.


\

First create a template raster of 1km * 1km cells using the downloaded worlclim data.
This raster is used to filter records to 1 per one 1km cell. This raster needs to have
the same extent and resolution of the data used to analyse the species distributions.
Fetch a cup of tea this takes ages.....

```{r message=FALSE, echo=FALSE, warning=FALSE}


## Use gdal to create a template raster in WGS84
template.raster.1km <- gdalwarp("./data/wc2-5/bio1.bil",
                                tempfile(fileext = '.bil'),
                                t_srs = '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs',
                                output_Raster = TRUE,
                                tr = c(1000, 1000),
                                r = "near", dstnodata = '-9999') %>% 
  projectRaster(., crs = '+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0')


## Should be 1km*1km 
xres(template.raster.1km)

``` 


\

Note that the order of the raster names in 'world_raster' must match the order of names in env_variables.
In this case, it's simply the biolclim variables (i.e. bio1- bio19)

```{r message=FALSE, echo=TRUE, warning=FALSE}

## Combine GBIF and ALA data, and extract environmental values
COMBO.RASTER.CONVERT = combine_records_extract(ala_df          = ALA.LAND,
                                               gbif_df         = GBIF.LAND,
                                               urban_df        = 'NONE',
                                               thin_records    = TRUE,
                                               template_raster = template.raster.1km,
                                               world_raster    = worldclim_climate,
                                               prj             = CRS("+init=epsg:4326"),
                                               species_list    = analysis_spp,
                                               biocl_vars      = bioclim_variables,
                                               env_vars        = env_variables,
                                               worldclim_grids = "TRUE",
                                               save_data       = "FALSE",
                                               save_run        = "TEST_BATS")

``` 

\

# STEP 4 :: Flag institutional outliers

\

The next stage of the process runs a series of cleaning steps. This function takes a data frame of all 
species records, and flag records as institutional or spatial outliers. It uses the CoordinateCleaner 
package https://cran.r-project.org/web/packages/CoordinateCleaner/index.html. It assumes that the 
records data.frame is that returned by the combine_records_extract function.

```{r message=FALSE, echo=TRUE, warning=FALSE}

## :: Flag records as institutional or spatial outliers
COORD.CLEAN = coord_clean_records(records    = COMBO.RASTER.CONVERT,
                                  capitals   = 10000,  ## Remove records within 10km  of capitals
                                  centroids  = 5000,   ## Remove records within 5km of country centroids
                                  save_run   = "TEST_SPECIES",
                                  #data_path    = "./output/results/",
                                  save_data  = "FALSE")
``` 

\

Note that the order of the raster names in 'world_raster' must match the order of names in env_variables.
In this case, it's simply the biolclim variables (i.e. bio1- bio19)

```{r message=FALSE, echo=TRUE, warning=FALSE}

## Step 4b :: Flag spatial outliers
SPATIAL.CLEAN = check_spatial_outliers(all_df       = COORD.CLEAN,
                                       land_shp     = LAND,
                                       urban_df     = FALSE, #URBAN.RASTER.CONVERT,
                                       clean_path   = './data/GBIF/Check_plots/',
                                       spatial_mult = 10,
                                       prj          = CRS("+init=epsg:4326"))
``` 

\

Note that the order of the raster names in 'world_raster' must match the order of names in env_variables.
In this case, it's simply the biolclim variables (i.e. bio1- bio19)

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Step 4c ::Estima ecliate niches usign pecies records
GLOB.NICHE = calc_1km_niches(coord_df     = SPATIAL.CLEAN,  ## Replace COORD.CLEAN
                             prj          = CRS("+init=epsg:4326"),
                             country_shp  = AUS,
                             world_shp    = LAND,
                             kop_shp      = Koppen_shp,
                             ibra_shp     = IBRA,
                             species_list = analysis_spp,
                             env_vars     = env_variables,
                             cell_size    = 2,
                             save_run     = "Stoten_EG",
                             data_path    = "./output/results/",
                             save_data    = "TRUE")

``` 

\

Note that the order of the raster names in 'world_raster' must match the order of names in env_variables.
In this case, it's simply the biolclim variables (i.e. bio1- bio19)

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Step 4d :: plot species ranges using histograms and convex hulls for rainfall and temperature distributions
plot_range_histograms(coord_df     = SPATIAL.CLEAN,
                      species_list = analysis_spp,
                      range_path = './data/GBIF/Check_plots/')
``` 


\


# STEP 5 :: Prepare SDM table


\

Note that the order of the raster names in 'world_raster' must match the order of names in env_variables.
In this case, it's simply the biolclim variables (i.e. bio1- bio19)

```{r message=FALSE, echo=FALSE, warning=FALSE}

SDM.SPAT.OCC.BG = prepare_sdm_table(coord_df        = COORD.CLEAN,
                                    species_list    = unique(COORD.CLEAN$searchTaxon),
                                    sdm_table_vars  = sdm_table_vars,
                                    prj             = CRS("+init=ESRI:54009"),
                                    save_run        = "test_species",
                                    read_background = "FALSE",
                                    save_data       = "FALSE",
                                    save_shp        = "FALSE")

``` 


\




