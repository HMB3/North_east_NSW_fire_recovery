---
title: "sdmgen : a pacakge for rapidly estimating multiple species ranges and habit sutiability"
authors: "Hugh Burley, John Baumgartner, Linda Beaumont"
date: "March 2020"
output:
  html_document:
  toc: true             # Table of content true
toc_depth: 4            # Up to three depths of headings (specified by #, ## and html_document
toc_float: true
number_sections: false  # If you want number sections at each table header
theme: united           # Many options for theme, this one is my favorite.
highlight: tango        # Specifies the syntax highlighting style
css: styles.css
revealjs::revealjs_presentation:
  dev: 'svg'
css: styles.css
self_contained: false
reveal_plugins: ["notes", "search"]
reveal_options:
  slideNumber: true
previewLinks: true
word_document:
  always_allow_html: yes
---
  
  
  <style>
  p.caption {
    font-size: 6;
  }
</style>
  


\

The text and code below summarises a workflow in R that can be used to relatively rapidly assess the effect
of climate change on a species within Australia, from downloading occurrence records, through to creating
maps of predicted climatic suitability across Australia at 1km*1km resolution. An example of this work is 
published in Science of the Total Environment ::

\

Burley, H., Beaumont, L.J., Ossola, A., et al. (2019) Substantial declines in urban tree habitat predicted 
under climate change. Science of The Total Environment, 685, 451-462.

https://www.sciencedirect.com/science/article/pii/S0048969719323289#f0030 


\


### To install, run :

```{r message=FALSE, echo=FALSE, warning=FALSE}

## The package should import all the required packges
devtools::install_github("HMB3/sdmgen")
library(sdmgen)


## Load the packages
data("sdmgen_packages")
sapply(sdmgen_packages, require, character.only = TRUE)


```


\


# STEP 1 :: Download species occurrence data
            

\

The backbone of the R workflow is a list of (taxonomically Ridgey Didge!) species names 
that we supply. The analysis is designed to process data for one species at a time, 
allowing species results to be updated as required. We can demonstrate the workflow 
using a sample of 10 plant species from the Stoten publication above. 


\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Use the first 10 plant species in the Stoten list
data("plant.spp")
analysis_spp <- plant.spp[1:10]
analysis_spp

```

\

First, we use two functions to download all species records from the Atlas and living Australia
(https://www.ala.org.au/) and the Global Biodiversity Information Facility (GBIF, https://www.gbif.org/). 
It downloads the species data as individual .Rdata files to the specified folders, which must exist first, 
without returning anything. The functions are separated because the ALA and GBIF columns are slightly different, 
but both data sources are needed to properly quantify species ranges .

\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## The functions expect these folders, create them if they don't exist
ALA_dir  <- './data/ALA'
GBIF_dir <- './data/GBIF'


## Create ALA subfolder
if(!dir.exists(ALA_dir)) {
            message('Creating MESS directory for ', species)
            dir.create(ALA_dir) } else {
              'ALA directory already exists'}


## Create GBIF subfolder
if(!dir.exists(GBIF_dir)) {
            message('Creating MESS directory for ', species)
            dir.create(GBIF_dir) } else {
              'GBIF directory already exists'}

```

\


```{r message=FALSE, echo=FALSE, warning=FALSE}

## Download GBIF occurrence data for each species
download_GBIF_all_species(species_list  = analysis_spp,
                          download_path = "./data/GBIF/",
                          download_limit = 20000)


## Download ALA occurrence data for each species
download_ALA_all_species(species_list  = analysis_spp,
                         your_email    = 'hugh.burley@gmail.com',
                         download_path = "./data/ALA/",
                         download_limit = 20000)

``` 

\

# STEP 2 :: Combine species occurrence data

\

The next function combines ALA and GBIF data, and filter to records on land, taken > 1950
The climate data (i.e. raster) used can be any worldclim layer.

\

First, get some global climate data from worldclim

\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Download global raster for minimum temperature 
##worldclim_annual_temp <- raster::getData('worldclim', var='bio', res = 2.5)
worldclim_annual_temp <- raster::stack("./wc2-5/bio1.bil")
sp::plot(worldclim_annual_temp)

``` 

\

Then trim the occurrence records to those inside the raster boundaries (i.e. species records in the ocean
according to the Raster boundaries will be excluded)

\

```{r message=FALSE, echo=FALSE, warning=FALSE}

## Combine ALA data, and filter to records on land taken > 1950
## The climate data is the worldclim version 1.0
ALA.LAND = combine_ala_records(species_list      = analysis_spp,
                               records_path      = "./data/ALA/",
                               records_extension = "_ALA_records.RData",
                               record_type       = "ALA",
                               keep_cols         = ALA_keep,
                               world_raster      = worldclim_annual_temp)


## Combine GBIF data and filter to records on land taken > 1950
GBIF.LAND = combine_gbif_records(species_list      = analysis_spp,
                                 records_path      = "./data/GBIF/",
                                 records_extension = "_GBIF_records.RData",
                                 record_type       = "GBIF",
                                 keep_cols         = gbif_keep,
                                 world_raster      = worldclim_annual_temp)

``` 

\

# STEP 3 :: extract environmental values

\

The next function combines occurrence files from ALA and GBIF into one table, and extracts enviro values.
It assumes that both files come from the combine_ala_records and combine_gbif_records functions.


```{r message=FALSE, echo=FALSE, warning=FALSE}

## First get the raster template
## need to update raster data here
#data('template_raster_1km_84')


## Combine GBIF and ALA data, and extract environmental values
COMBO.RASTER.CONVERT = combine_records_extract(ala_df          = ALA.LAND,
                                               gbif_df         = GBIF.LAND,
                                               urban_df        = 'NONE',
                                               thin_records    = TRUE,
                                               template_raster = template.raster.1km.84,
                                               world_raster    = worldclim_annual_temp,
                                               projection      = CRS("+init=epsg:4326"),
                                               species_list    = analysis_spp,
                                               biocl_vars      = bioclim_variables,
                                               env_vars        = env_variables,
                                               worldclim_grids = "TRUE",
                                               save_data       = "FALSE",
                                               save_run        = "TEST_BATS")

``` 





